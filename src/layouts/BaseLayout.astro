---
import '../styles/global.css';
import GTMHead from '../components/GTMHead.astro';
import GTMBody from '../components/GTMBody.astro';
import Header from '../components/Header.astro';
import MobileContactBar from '../components/MobileContactBar.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title: string;
  description: string;
}

const { title, description } = Astro.props;
---

<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <meta name="format-detection" content="telephone=yes" />
    <meta name="theme-color" content="#FFC107" />
    <meta name="color-scheme" content="dark" />
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="/favicon-16x16.svg" />
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="/favicon-32x32.svg" />
    <link rel="apple-touch-icon" href="/favicon.svg" />
    
    <!-- SEO Meta Tags -->
    <meta name="description" content={description} />
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
    <meta name="googlebot" content="index, follow" />
    <meta name="author" content="İkitelli Turbocu" />
    <meta name="language" content="Turkish" />
    <meta name="geo.region" content="TR-34" />
    <meta name="geo.placename" content="İstanbul" />
    <meta name="geo.position" content="41.0783;28.7833" />
    <meta name="ICBM" content="41.0783, 28.7833" />
    
    <!-- Resource Hints - Performance Optimization -->
    <link rel="preconnect" href="https://www.ikitelliturbocu.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.ikitelliturbocu.com" />
    <link rel="preconnect" href="https://wa.me" crossorigin />
    <link rel="dns-prefetch" href="https://wa.me" />
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    
    <!-- Google Tag Manager - Async loading -->
    <GTMHead />
    
    <slot name="head" />
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <GTMBody />
    
    <Header />
    <main>
      <slot />
    </main>
    <MobileContactBar />
    <Footer />
    
    <!-- GTM Event Tracking Script -->
    <script is:inline>
      (function() {
        // Track page view
        if (typeof window !== 'undefined' && window.dataLayer) {
          window.dataLayer.push({
            'event': 'page_view',
            'page_path': window.location.pathname,
            'page_title': document.title,
            'page_location': window.location.href
          });
        }

        // Setup event listeners after DOM is ready
        function setupGTMListeners() {
          // Track phone clicks
          document.querySelectorAll('a[href^="tel:"]').forEach(function(link) {
            link.addEventListener('click', function(e) {
              var href = this.href;
              var phoneNumber = href.replace('tel:', '');
              if (window.dataLayer) {
                window.dataLayer.push({
                  'event': 'phone_click',
                  'phone_number': phoneNumber,
                  'location': window.location.pathname,
                  'page_path': window.location.pathname
                });
              }
            });
          });

          // Track WhatsApp clicks
          document.querySelectorAll('a[href*="wa.me"]').forEach(function(link) {
            link.addEventListener('click', function(e) {
              if (window.dataLayer) {
                window.dataLayer.push({
                  'event': 'whatsapp_click',
                  'location': window.location.pathname,
                  'page_path': window.location.pathname
                });
              }
            });
          });

          // Track social media clicks - Use event delegation for better reliability
          // This captures clicks on social links even if they're added dynamically
          document.addEventListener('click', function(e) {
            var target = e.target;
            // Find the closest anchor tag
            var anchor = target;
            while (anchor && anchor.nodeName !== 'A' && anchor !== document.body) {
              anchor = anchor.parentElement;
            }
            
            if (anchor && anchor.href && anchor.nodeName === 'A') {
              var href = anchor.href.toLowerCase();
              var platform = null;
              
              // Check for Instagram (more comprehensive check)
              if (href.indexOf('instagram.com') !== -1 || href.indexOf('instagram') !== -1) {
                platform = 'instagram';
              }
              // Check for Facebook
              else if (href.indexOf('facebook.com') !== -1 || href.indexOf('facebook') !== -1) {
                platform = 'facebook';
              }
              
              // Track if it's a social media link
              if (platform && window.dataLayer) {
                window.dataLayer.push({
                  'event': 'social_click',
                  'social_platform': platform,
                  'social_url': anchor.href,
                  'page_path': window.location.pathname,
                  'link_text': anchor.textContent ? anchor.textContent.trim().substring(0, 100) : '',
                  'link_location': anchor.closest('header') ? 'header' : 
                                  anchor.closest('footer') ? 'footer' : 
                                  anchor.closest('nav') ? 'navigation' : 'content'
                });
              }
            }
          }, true); // Use capture phase for better reliability

          // Track service detail clicks
          document.querySelectorAll('a[href^="/hizmetler/"]').forEach(function(link) {
            link.addEventListener('click', function(e) {
              var serviceName = this.getAttribute('data-gtm-service') || this.textContent.trim() || 'Unknown';
              if (window.dataLayer) {
                window.dataLayer.push({
                  'event': 'service_click',
                  'service_name': serviceName,
                  'service_url': this.href,
                  'page_path': window.location.pathname
                });
              }
            });
          });
        }

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setupGTMListeners);
        } else {
          setupGTMListeners();
        }
      })();
    </script>
  </body>
</html>

